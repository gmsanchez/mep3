<root main_tree_to_execute="BehaviorTree">
    <!-- ////////// -->
    <BehaviorTree ID="BehaviorTree">
        <Sequence>
            <WaitMatchStart state="1" />
            <DefaultTeamColor color="purple" />

            <AddObstacle label="initial_static_three" polygon="0.54;0.43|0.67;0.43|0.67;0.2|0.54;0.2" />
            <AddObstacle label="initial_random_three" polygon="0.532;-0.24|0.6;-0.45|0.44;-0.45" />
            <AddObstacle label="initial_force_middle" polygon="0.5;0.5|0.5;0.7|0.8;0.7|0.8;0.5" />
            <Wait duration="1.0"/>
            <!-- <Navigate goal="-0.8;0.0;0" /> -->
            <PoseToFullPose pose="0.2;0.6;90" full_pose="{goal}" />
            <ComputePathToPose goal="{goal}" path="{path}" planner_id="GridBased" />

            <RemoveObstacle label="initial_force_middle" />
        
            <WaitMatchStart state="2" />
            <FollowPath path="{path}" controller_id="FollowPath" />


		    <SubTreePlus ID="SafePreciseNavigate" goal="0.226;0.400;90" type="safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />

		    <Motion command="forward" velocity_linear="1.4" acceleration_linear="1.0" velocity_angular="20.0" acceleration_angular="20.0" value="0" /> 
            <SubTree ID="collect_from_dispenser_middle_ours" __shared_blackboard="true" />
            <SubTree ID="task_put_3_from_left_on_gallery" __shared_blackboard="true" />

            <SubTree ID="collect_from_dispenser_only_ours" __shared_blackboard="true"/>

		    <SubTree ID="task_put_second_3_from_left_on_gallery" __shared_blackboard="true" />

            <Wait duration="10000000.0" name="Wait forever as small robot" />
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="SafePreciseNavigate">
        <SequenceStar>
            <ClearEntireCostmap name="ClearLocalCostmap-Context" service_name="local_costmap/clear_entirely_local_costmap" />
            <RecoveryNode number_of_retries="3" name="FollowPath">
                <PreciseNavigate goal="{goal}" behavior_tree="{type}" />
                <Sequence>
                    <Wait duration="0.5" />
                    <ClearEntireCostmap name="ClearLocalCostmap-Context" service_name="local_costmap/clear_entirely_local_costmap" />
                    <Wait duration="0.5" />
                </Sequence>
            </RecoveryNode>
        </SequenceStar>
    </BehaviorTree>


    <BehaviorTree ID="collect_from_dispenser_middle_ours">
        <Sequence>

            <PreciseNavigate goal="0.226;0.450;90"/>
            <Parallel failure_threshold="1" success_threshold="2">
                <PreciseNavigate goal="0.226;0.600;90"/>
                <Dynamixel label="fork_left" position="85" velocity="540"/>
            </Parallel>
            
            <PreciseNavigate goal="0.228;0.768;90"/>

            <Motion command="forward" value="0" velocity_linear="1.0" acceleration_linear="0.4" /> 
            <ForceSuccess>
                <Motion command="forward_stuck" value="0.01" /> <!-- Simulacija-->
                <!-- <Motion command="forward_stuck" value="0.05" />  -->
                </ForceSuccess>
            <Motion command="forward" value="0" velocity_linear="1.4" acceleration_linear="1.0" /> 


            <Dynamixel label="fork_left" position="183" velocity="150"/>
            <Motion command="forward" value="-0.18" /> 
        
        </Sequence>
    </BehaviorTree>


    <BehaviorTree ID="task_put_3_from_left_on_gallery">
        <Sequence>
	    <PreciseNavigate goal="0.700;0.720;0"/>

	    <!-- Ostavljanje pakova -->

	    <Parallel failure_threshold="1" success_threshold="2">
		    <PreciseNavigate goal="0.330;0.740;0" behavior_tree="backward"/>
		    <SubTree ID="skill_retract_hands" __shared_blackboard="true" />
	    </Parallel>
	    <SubTree ID="skill_take_first_from_left" __shared_blackboard="true" />
	    <SubTree ID="leave_down_iz_daleka" __shared_blackboard="true" />

	    <Parallel failure_threshold="1" success_threshold="2">
		    <PreciseNavigate goal="0.585;0.755;0"/>
		    <SubTree ID="skill_retract_hands" __shared_blackboard="true" />
	    </Parallel>
	    <SubTree ID="skill_take_second_from_left" __shared_blackboard="true" />
	    <SubTree ID="leave_down" __shared_blackboard="true" />

	    <Parallel failure_threshold="1" success_threshold="2">
		    <PreciseNavigate goal="0.950;0.755;0"/>
		    <SubTree ID="skill_retract_hands" __shared_blackboard="true" />
	    </Parallel>
	    <SubTree ID="skill_take_third_from_left" __shared_blackboard="true" />
	    <SubTree ID="leave_down" __shared_blackboard="true" />

	    <SubTree ID="skill_retract_hands" __shared_blackboard="true" />

	    <PreciseNavigate goal="1.200;0.755;0"/>

        </Sequence>
    </BehaviorTree>


     <BehaviorTree ID="skill_retract_hands">
        <Sequence>

            <Parallel failure_threshold="1" success_threshold="4">
                <Dynamixel label="mid" position="30" velocity="450"/>
                <Dynamixel label="gripper" position="180" velocity="450"/>
                <Dynamixel label="base" position="67" velocity="450"/>
                <Dynamixel label="rail" position="68" velocity="450"/>
            </Parallel>

            <Parallel failure_threshold="1" success_threshold="2">
		    <Dynamixel label="fork_right" position="183" velocity="450"/>
		    <Dynamixel label="fork_left" position="183" velocity="450"/>
            </Parallel>

        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="skill_prepare_for_right">
        <Sequence>

            <Parallel failure_threshold="1" success_threshold="3">
                <Dynamixel label="mid" position="35" velocity="450"/>
                <Dynamixel label="gripper" position="180" velocity="450"/>
                <Dynamixel label="rail" position="97" velocity="450"/>
            </Parallel>
		    
	    <Dynamixel label="base" position="240" velocity="450"/>

            <Parallel failure_threshold="1" success_threshold="2">
		    <Dynamixel label="fork_right" position="183" velocity="450"/>
		    <Dynamixel label="fork_left" position="183" velocity="450"/>
            </Parallel>

        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="skill_take_first_from_left">
        <Sequence>
	
            <Parallel failure_threshold="1" success_threshold="5">
		    <Dynamixel label="fork_left" position="140" velocity="450"/>
		    <Dynamixel label="rail" position="68" velocity="450"/>
		    <Dynamixel label="base" position="85" velocity="450"/>
		    <Dynamixel label="gripper" position="250" velocity="450"/>
		    <VacuumPump label="arm_connector" connect="1"/>	
            </Parallel>

            <Dynamixel label="mid" position="78" velocity="250"/>

            <SubTree ID="skill_prepare_to_leave_from_left" __shared_blackboard="true" />

        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="skill_take_second_from_left">
        <Sequence>
            <Parallel failure_threshold="1" success_threshold="5">
		    <Dynamixel label="fork_left" position="138" velocity="450"/>
		    <Dynamixel label="rail" position="68" velocity="450"/>
		    <Dynamixel label="base" position="80" velocity="450"/>
		    <Dynamixel label="gripper" position="240" velocity="450"/>
		    <VacuumPump label="arm_connector" connect="1"/>	
            </Parallel>

            <Dynamixel label="mid" position="80" velocity="250"/>

	    <SubTree ID="skill_prepare_to_leave_from_left" __shared_blackboard="true" />
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="skill_take_third_from_left">
        <Sequence>
            <Parallel failure_threshold="1" success_threshold="5">
		    <Dynamixel label="fork_left" position="138" velocity="450"/>
		    <Dynamixel label="rail" position="68" velocity="450"/>
		    <Dynamixel label="base" position="80" velocity="450"/>
		    <Dynamixel label="gripper" position="230" velocity="450"/>
		    <VacuumPump label="arm_connector" connect="1"/>	
            </Parallel>

            <Dynamixel label="mid" position="90" velocity="250"/>
	    
	    <SubTree ID="skill_prepare_to_leave_from_left" __shared_blackboard="true" />

        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="skill_take_first_from_right">
        <Sequence>
	
            <Parallel failure_threshold="1" success_threshold="4">
		    <Dynamixel label="fork_right" position="138" velocity="450"/>
		    <Dynamixel label="rail" position="90" velocity="450"/>
		    <Dynamixel label="base" position="223" velocity="450"/>
		    <Dynamixel label="gripper" position="250" velocity="450"/>
		    <VacuumPump label="arm_connector" connect="1"/>	
            </Parallel>

            <Dynamixel label="mid" position="65" velocity="250"/>

	    <SubTree ID="skill_prepare_to_leave_from_right" __shared_blackboard="true" />

        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="skill_take_second_from_right">
        <Sequence>
	
            <Parallel failure_threshold="1" success_threshold="4">
		    <Dynamixel label="fork_right" position="138" velocity="450"/>
		    <Dynamixel label="rail" position="90" velocity="450"/>
		    <Dynamixel label="base" position="223" velocity="450"/>
		    <Dynamixel label="gripper" position="240" velocity="450"/>
		    <VacuumPump label="arm_connector" connect="1"/>	
            </Parallel>

            <Dynamixel label="mid" position="75" velocity="250"/>

	    <SubTree ID="skill_prepare_to_leave_from_right" __shared_blackboard="true" />

        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="skill_take_third_from_right">
        <Sequence>
	
            <Parallel failure_threshold="1" success_threshold="4">
		    <Dynamixel label="fork_right" position="138" velocity="450"/>
		    <Dynamixel label="rail" position="90" velocity="250"/>
		    <Dynamixel label="base" position="223" velocity="250"/>
		    <Dynamixel label="gripper" position="230" velocity="250"/>
		    <VacuumPump label="arm_connector" connect="1"/>	
            </Parallel>

            <Dynamixel label="mid" position="85" velocity="250"/>

	    <SubTree ID="skill_prepare_to_leave_from_right" __shared_blackboard="true" />


        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="skill_prepare_to_leave_from_right">
        <Sequence>	
	    <Dynamixel label="fork_right" position="138" velocity="250"/>
		    
	    <Dynamixel label="mid" position="30" velocity="150"/>
	    <Dynamixel label="gripper" position="200" velocity="150"/>

            <Parallel failure_threshold="1" success_threshold="2">
		    <Dynamixel label="base" position="67" velocity="150"/>
		    <Dynamixel label="rail" position="115" velocity="150"/>
            </Parallel>

	    <Dynamixel label="fork_left" position="183" velocity="450"/>
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="skill_prepare_to_leave_from_left">
        <Sequence>	
	    <Dynamixel label="fork_left" position="138" velocity="450"/>
		    
	    <Dynamixel label="mid" position="35" velocity="150"/>
            <Parallel failure_threshold="1" success_threshold="3">
		    <Dynamixel label="gripper" position="200" velocity="150"/>
		    <Dynamixel label="rail" position="115" velocity="150"/>
		    <Dynamixel label="base" position="67" velocity="150"/>
            </Parallel>
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="leave_down">
        <Sequence>
	
	    <Parallel success_threshold="1" failure_threshold="3">     
		    <Dynamixel label="mid" position="30" velocity="250"/>
		    <Dynamixel label="gripper" position="159" velocity="250"/>
		    <Dynamixel label="base" position="67" velocity="250"/>
	 	    <Dynamixel label="rail" position="120" velocity="250"/>
	    </Parallel>
	    <Dynamixel label="mid" position="82" velocity="50"/>
	    <!--Motion command="forward" value="-0.010" /--> 
	    <VacuumPump label="arm_connector" connect="0"/>	

	    <Parallel success_threshold="1" failure_threshold="2">     
		    <Dynamixel label="mid" position="30" velocity="250"/>
		    <Dynamixel label="rail" position="82" velocity="250"/>
	    </Parallel>
		
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="leave_down_iz_daleka">
        <Sequence>
	
	    <Parallel success_threshold="1" failure_threshold="3">     
		    <Dynamixel label="mid" position="30" velocity="250"/>
		    <Dynamixel label="gripper" position="150" velocity="250"/>
		    <Dynamixel label="base" position="67" velocity="250"/>
		    <Dynamixel label="rail" position="126" velocity="250"/>
	    </Parallel>
	    <Dynamixel label="mid" position="82" velocity="100"/>
	    <Wait duration="0.2" />
	    <VacuumPump label="arm_connector" connect="0"/>	

	    <Parallel success_threshold="1" failure_threshold="2">     
		    <Dynamixel label="mid" position="30" velocity="250"/>
		    <Dynamixel label="rail" position="82" velocity="250"/>
	    </Parallel>
		
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="leave_up">
        <Sequence>
	
	    <Dynamixel label="gripper" position="147" velocity="250"/>
	    <Dynamixel label="mid" position="40" velocity="100"/>
	    
            <Wait duration="0.2" />
	    <VacuumPump label="arm_connector" connect="0"/>	
            <Wait duration="0.5" />

	    <Parallel success_threshold="1" failure_threshold="3">     

		    <Dynamixel label="gripper" position="200" velocity="250"/>
		    <Dynamixel label="mid" position="30" velocity="250"/>
		    <Dynamixel label="rail" position="82" velocity="250"/>
            </Parallel>

        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="collect_from_dispenser_only_ours">
        <Sequence>

	    <PreciseNavigate goal="1.150;-0.326;0"/>
	    <Parallel failure_threshold="1" success_threshold="2">
		    <PreciseNavigate goal="1.220;-0.326;0"/>
		    <Dynamixel label="fork_left" position="85" velocity="450"/>
	    </Parallel>
	    
	    <PreciseNavigate goal="1.276;-0.326;0"/>

	    <Motion command="forward" value="0" velocity_linear="1.0" acceleration_linear="0.4" /> 
	    <ForceSuccess>
		    <Motion command="forward_stuck" value="0.04" /> 
            </ForceSuccess>
	    <Motion command="forward" value="0" velocity_linear="1.4" acceleration_linear="1.0" /> 

	    <Dynamixel label="fork_left" position="183" velocity="150"/>
	    <Motion command="forward" value="-0.13" /> 
	
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="task_put_second_3_from_left_on_gallery">
        <Sequence>
	    <PreciseNavigate goal="0.770;0.700;0"/>

	    <Parallel failure_threshold="1" success_threshold="2">
		    <PreciseNavigate goal="0.475;0.745;0" behavior_tree="backward"/>
		    <SubTree ID="skill_retract_hands" __shared_blackboard="true" />
	    </Parallel>
	    <SubTree ID="skill_take_first_from_left" __shared_blackboard="true" />
	    <SubTree ID="leave_down" __shared_blackboard="true" />

	    <Parallel failure_threshold="1" success_threshold="2">
		    <PreciseNavigate goal="0.735;0.755;0"/>
		    <SubTree ID="skill_retract_hands" __shared_blackboard="true" />
	    </Parallel>
	    <SubTree ID="skill_take_second_from_left" __shared_blackboard="true" />
	    <SubTree ID="leave_down" __shared_blackboard="true" />

	    <Parallel failure_threshold="1" success_threshold="2">
		    <PreciseNavigate goal="0.930;0.755;0"/>
		    <SubTree ID="skill_retract_hands" __shared_blackboard="true" />
	    </Parallel>
	    <SubTree ID="skill_take_third_from_left" __shared_blackboard="true" />
	    <SubTree ID="leave_up" __shared_blackboard="true" />

	    <SubTree ID="skill_retract_hands" __shared_blackboard="true" />

	    <PreciseNavigate goal="1.200;0.755;0"/>

        </Sequence>
    </BehaviorTree>
</root>
